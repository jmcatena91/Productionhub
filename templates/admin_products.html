<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Product List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Smooth animation for the details marker */
        details>summary {
            list-style: none;
        }

        details>summary::-webkit-details-marker {
            display: none;
        }

        details[open] summary~* {
            animation: sweep .3s ease-in-out;
        }

        @keyframes sweep {
            0% {
                opacity: 0;
                margin-top: -10px
            }

            100% {
                opacity: 1;
                margin-top: 0px
            }
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-200 font-sans min-h-screen pt-8 px-4">

    <div class="container mx-auto max-w-[95%]">
        <header class="bg-gray-800 rounded-lg shadow-md p-6 mb-8 border border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-amber-500">Product Admin</h1>
                    <p class="text-gray-400 text-sm mt-1">{{ products|length }} Total Items</p>
                </div>
                <div class="flex space-x-4">
                    <a href="{{ url_for('home') }}"
                        class="px-4 py-2 bg-gray-600 text-white font-medium rounded-md hover:bg-gray-700 transition">
                        Back to App
                    </a>
                    <a href="{{ url_for('admin_add') }}"
                        class="px-4 py-2 bg-green-600 text-white font-medium rounded-md hover:bg-green-700 transition">
                        + Add New Product
                    </a>
                    <a href="{{ url_for('logout') }}"
                        class="px-4 py-2 bg-red-600 text-white font-medium rounded-md hover:bg-red-700 transition">
                        Logout
                    </a>
                </div>
            </div>

            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <input type="text" id="adminSearch"
                    class="block w-full pl-10 pr-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-amber-500 transition"
                    placeholder="Search by ID, LWC, Insulation, Part Number, etc...">
            </div>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="mb-6 space-y-2">
            {% for category, message in messages %}
            <div
                class="p-3 rounded-md text-sm {% if category == 'danger' %}bg-red-900 text-red-300{% elif category == 'warning' %}bg-yellow-900 text-yellow-300{% else %}bg-green-900 text-green-300{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <div class="space-y-4" id="productGroups">
            {% for type, group in products|groupby('product_type') %}
            <details class="bg-gray-800 rounded-lg shadow-md border border-gray-700 group product-group">
                <summary
                    class="cursor-pointer p-4 flex justify-between items-center hover:bg-gray-750 transition select-none">
                    <div class="flex items-center gap-3">
                        <span class="text-amber-500 transition-transform duration-200 group-open:rotate-90">â–¶</span>
                        <h2 class="text-xl font-bold text-white">Type {{ type }}</h2>
                        <span class="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded-full">{{ group|length }}
                            items</span>
                    </div>
                </summary>

                <div class="p-4 overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead>
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase">ID</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase">LWC</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase">Partner</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase">Insulation
                                </th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase">Length</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase">Blade</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase">QTY.</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase">Box</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-amber-500 uppercase">Part #</th>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-400 uppercase">Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            {% for product in group %}
                            <tr class="hover:bg-gray-700/50 transition product-row">
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-500">{{ product.id
                                    }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-white">{{ product.lwc }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300">{{ product.partner if
                                    product.partner else '' }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-white">{{ product.insulation }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-white">{{ product.length }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-white">{{ product.bladeSize }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-white">{{ product.qtyPerPallet }}
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-white">{{ product.boxPallet }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-mono text-amber-400">{{
                                    product.partNumber }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                    <a href="{{ url_for('admin_edit', product_id=product.id) }}"
                                        class="text-blue-400 hover:text-blue-500">Edit</a>
                                    <form method="POST" action="{{ url_for('admin_delete', product_id=product.id) }}"
                                        style="display:inline;" onsubmit="return confirm('Delete this product?');">
                                        <button type="submit" class="text-red-400 hover:text-red-500">Del</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </details>
            {% endfor %}
        </div>
    </div>

    <script>
        document.getElementById('adminSearch').addEventListener('input', function (e) {
            const searchTerm = e.target.value.toLowerCase();
            const groups = document.querySelectorAll('.product-group');

            groups.forEach(group => {
                const rows = group.querySelectorAll('.product-row');
                let hasVisibleRows = false;

                rows.forEach(row => {
                    // Search within all text content of the row
                    const text = row.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        row.style.display = '';
                        hasVisibleRows = true;
                    } else {
                        row.style.display = 'none';
                    }
                });

                // Logic for the Group Accordion
                if (hasVisibleRows) {
                    group.style.display = ''; // Show the group
                    // If actively searching, open the accordion. 
                    // If search matches nothing (empty string), collapse it back for neatness.
                    if (searchTerm !== '') {
                        group.open = true;
                    } else {
                        group.open = false;
                    }
                } else {
                    group.style.display = 'none'; // Hide group if no rows match
                }
            });
        });
    </script>
</body>

</html>